<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>SFDevs | Using() block hell in C#</title><meta name=description content="So the other day I was working on transforming streams for an encryption layer for work. I ended up having some code that looked similar to this:
public async Task SendAsync(byte[] data, Delegate next) { using (var stream = ...) { using (var encryptStream = ...) { using (var encodeStream = ...) { using (var reader = ...) { await next(...); } } } } } public async Task RecieveAsync(byte[] data, Delegate next) { using (var stream = ."><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=icon href=favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.58.3"><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/solid.js integrity=sha384-IA6YnujJIO+z1m4NKyAGvZ9Wmxrd4Px8WFqhFcgRmwLaJaiwijYgApVpo1MV8p77 crossorigin=anonymous></script><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/brands.js integrity=sha384-rUOIFHM3HXni/WG5pzDhA1e2Js5nn4bWudTYujHbbI9ztBIxK54CL4ZNZWwcBQeD crossorigin=anonymous></script><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/fontawesome.js integrity=sha384-EMmnH+Njn8umuoSMZ3Ae3bC9hDknHKOWL2e9WJD/cN6XLeAN7tr5ZQ0Hx5HDHtkS crossorigin=anonymous></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:500,900|Knewave"><link rel=stylesheet href=/styles/main.c1af6829ba8f007e9a41864163894b2474ad2b5f7b38b6def082239dd6da9cf3.css integrity="sha256-wa9oKbqPAH6aQYZBY4lLJHStK197OLbe8IIjndbanPM="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#6cc091><meta name=msapplication-TileColor content=#da532c><meta name=theme-color content=#6cc091><link rel=canonical href=http://austinhanson.com/using-block-hell-in-c><meta property=og:title content="Using() block hell in C#"><meta property=og:description content="So the other day I was working on transforming streams for an encryption layer for work. I ended up having some code that looked similar to this:
public async Task SendAsync(byte[] data, Delegate next) { using (var stream = ...) { using (var encryptStream = ...) { using (var encodeStream = ...) { using (var reader = ...) { await next(...); } } } } } public async Task RecieveAsync(byte[] data, Delegate next) { using (var stream = ."><meta property=og:type content=article><meta property=og:url content=https://sfdevs.com/posts/external_posts/2017-04-28-austin-hanson-using-block-hell-in-c/><meta property=article:published_time content=2017-04-28T20:05:00+00:00><meta property=article:modified_time content=2017-04-28T20:05:00+00:00><meta property=fb:app_id content=1171673062996168><meta itemprop=name content="Using() block hell in C#"><meta itemprop=description content="So the other day I was working on transforming streams for an encryption layer for work. I ended up having some code that looked similar to this:
public async Task SendAsync(byte[] data, Delegate next) { using (var stream = ...) { using (var encryptStream = ...) { using (var encodeStream = ...) { using (var reader = ...) { await next(...); } } } } } public async Task RecieveAsync(byte[] data, Delegate next) { using (var stream = ."><meta itemprop=datePublished content=2017-04-28T20:05:00&#43;00:00><meta itemprop=dateModified content=2017-04-28T20:05:00&#43;00:00><meta itemprop=wordCount content=377><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Using() block hell in C#"><meta name=twitter:description content="So the other day I was working on transforming streams for an encryption layer for work. I ended up having some code that looked similar to this:
public async Task SendAsync(byte[] data, Delegate next) { using (var stream = ...) { using (var encryptStream = ...) { using (var encodeStream = ...) { using (var reader = ...) { await next(...); } } } } } public async Task RecieveAsync(byte[] data, Delegate next) { using (var stream = ."><meta name=twitter:site content=@_sfdevs><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-89597259-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>window.fbAsyncInit=function(){FB.init({appId:'1171673062996168',cookie:true,xfbml:true,version:'v3.2'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/en_US/sdk.js";fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><body class=subpage><header id=header><div class=inner><a href=https://sfdevs.com/ class=logo>SFDevs</a><nav id=nav role=menu><a href=/about/><span>About</span></a>
<a href=/posts/><span>Community Posts</span></a>
<a href=/jobs/><span>Jobs</span></a></nav><a href=#navPanel class=navPanelToggle><span class="fa fa-bars"></span></a></div></header><section class=wrapper><div class=inner><header class=align-center><h1>Using() block hell in C#</h1></header><p>So the other day I was working on transforming streams for an encryption layer for work. I ended up having some code that looked similar to this:</p><pre><code>public async Task SendAsync(byte[] data, Delegate next)
{
    using (var stream = ...)
    {
        using (var encryptStream = ...)
        {
            using (var encodeStream = ...)
            {
                using (var reader = ...)
                {
                    await next(...);
                }
            }
        }
    }
}


public async Task RecieveAsync(byte[] data, Delegate next)
{
    using (var stream = ...)
    {
        using (var decodeStream = ...)
        {
            using (var decryptStream = ...)
            {
                using (var reader = ...)
                {
                    await next(...);
                }
            }
        }
    }
}

</code></pre><p>Which doesn’t look very great! There’s a nice solution relying on next-line context statements showcased over at <a href=http://stackoverflow.com/questions/6227264/using-block-galore>stackoverflow</a> but my colleagues and I agreed that “hack” doesn’t necessarily get us what we want. There’s a reason most people don’t do:</p><pre><code>if (this)
if (andThat)
if (andKitchenSink)
{
    // Do stuff
}

</code></pre><p>It’s just as ugly in a non-aesthetic way.</p><p>Ok, what about just using try/finally?</p><pre><code>public async Task SendAsync(byte[] data, Delegate next)
{
    IDisposable stream = null, encryptedStream = null, encodeStream = null;
    StreamReader reader = null;

    try {
        stream = ...;
        encryptStream = ...;
        encodeStream = ...;
        reader = ...;
        await next(...);
    }
    finally
    {
        stream?.Dispose();
        encryptedStream?.Dispose();
        encodedStream?.Dispose();
        reader?.Dispose();
    }
}


public async Task RecieveAsync(byte[] data, Delegate next)
{
    var stream = null, decodeStream = null, decryptStream = null;
    StreamReader reader = null;
    try {
        stream = ...;
        decodeStream = ...;
        decryptStream = ...;
        reader = ...;
        await next(...);
    }
    finally
    {
        stream?.Dispose();
        decodeStream?.Dispose();
        decryptStream?.Dispose();
        reader?.Dispose();
    }    
}

</code></pre><p>But…that’s equally bad to look at. So I threw together a builder pattern that makes the above look something like this:</p><pre><code>public async Task SendAsync(byte[] data, Delegate next)
{
    With.Using(() =&amp;gt; new ...)
        .Using(memoryStream =&amp;gt; ...)
        .Using(cryptoStream =&amp;gt; ...)
        .Using(base64Stream =&amp;gt; ...)
        .Then(async streamReader =&amp;gt; await next(...));
}

public async Task RecieveAsync(byte[] data, Delegate next)
{
    With.Using(() =&amp;gt; new ...)
        .Using(memoryStream =&amp;gt; ...)
        .Using(base64Stream =&amp;gt; ...)
        .Using(cryptoStream =&amp;gt; ...)
        .Then(async streamReader =&amp;gt; await next(...));
}

</code></pre><p>I think it looks pretty clean? Obviously this isn’t something you just throw into a JobCorpCo code base but it’s a fun exercise in what you can do with code. If you’re interested, here are the <a href=https://gist.github.com/berdon/3b568684a57f36c237e0546f61465da3#file-usingbuilder-cs>helper classes</a>.</p></div></section><footer id=footer><div class=inner><h3>Get in touch</h3><iframe src="https://services.cognitoforms.com/f/kLQF89okA06rKO0JYMWNOg?id=1" style=position:relative;width:1px;min-width:100%;*width:100% frameborder=0 scrolling=yes seamless height=465 width=100%></iframe>
<script src=https://services.cognitoforms.com/scripts/embed.js></script><div class="row footer__copy-social"><div class="copyright 6u 12u$(small)">&copy; 2019 Sioux Falls Developer's Group.</div><div class="6u 12u$(small) social"><div class=footer__social><span class=follow__social__copy>Follow SFDevs</span>
<a href=https://www.facebook.com/sfdevs title="Follow us on Facebook" class=like-us target=_blank rel=noopener><i class="fab fa-facebook fa-2x"></i></a><a href=https://twitter.com/_sfdevs title="Follow us on Twitter" class=like-us target=_blank rel=noopener><i class="fab fa-twitter fa-2x"></i></a></div></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin=anonymous></script><script src=/js/skel.min.js></script><script src=/js/main.min.js></script></body></html>