<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>SFDevs | AWS Lambda Functions with Modular Powershell</title><meta name=description content="It’s been a while since AWS released support for running Powershell in Lambda Functions. Up until now all of the Lambda functions I’ve worked with have been either python or NodeJS, but we recently had a project that needed to update a database from inside of a deployment pipeline.
We’re trying to retire an old admin box where users would run Powershell management scripts to do things like provision servers, configure customer accounts, etc."><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=icon href=favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.63.1"><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/solid.js integrity=sha384-IA6YnujJIO+z1m4NKyAGvZ9Wmxrd4Px8WFqhFcgRmwLaJaiwijYgApVpo1MV8p77 crossorigin=anonymous></script><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/brands.js integrity=sha384-rUOIFHM3HXni/WG5pzDhA1e2Js5nn4bWudTYujHbbI9ztBIxK54CL4ZNZWwcBQeD crossorigin=anonymous></script><script defer src=https://use.fontawesome.com/releases/v5.8.1/js/fontawesome.js integrity=sha384-EMmnH+Njn8umuoSMZ3Ae3bC9hDknHKOWL2e9WJD/cN6XLeAN7tr5ZQ0Hx5HDHtkS crossorigin=anonymous></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:500,900|Knewave"><link rel=stylesheet href=/styles/main.eb9f00a194b437f34b7432adf19800e00495fc8df66765d2a553eeaa86d38fa6.css integrity="sha256-658AoZS0N/NLdDKt8ZgA4ASV/I32Z2XSpVPuqobTj6Y="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#6cc091><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#6cc091"><link rel=canonical href=https://rollingwebsphere.home.blog/2020/01/18/aws-lambda-functions-with-modular-powershell/><meta property="og:title" content="AWS Lambda Functions with Modular Powershell"><meta property="og:description" content="It’s been a while since AWS released support for running Powershell in Lambda Functions. Up until now all of the Lambda functions I’ve worked with have been either python or NodeJS, but we recently had a project that needed to update a database from inside of a deployment pipeline.
We’re trying to retire an old admin box where users would run Powershell management scripts to do things like provision servers, configure customer accounts, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://sfdevs.com/posts/external_posts/2020-01-18-brian-olson-aws-lambda-functions-with-modular-powershell/"><meta property="article:published_time" content="2020-01-18T23:46:00+00:00"><meta property="article:modified_time" content="2020-01-18T23:46:00+00:00"><meta property="fb:app_id" content="1171673062996168"><meta itemprop=name content="AWS Lambda Functions with Modular Powershell"><meta itemprop=description content="It’s been a while since AWS released support for running Powershell in Lambda Functions. Up until now all of the Lambda functions I’ve worked with have been either python or NodeJS, but we recently had a project that needed to update a database from inside of a deployment pipeline.
We’re trying to retire an old admin box where users would run Powershell management scripts to do things like provision servers, configure customer accounts, etc."><meta itemprop=datePublished content="2020-01-18T23:46:00+00:00"><meta itemprop=dateModified content="2020-01-18T23:46:00+00:00"><meta itemprop=wordCount content="1154"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Lambda Functions with Modular Powershell"><meta name=twitter:description content="It’s been a while since AWS released support for running Powershell in Lambda Functions. Up until now all of the Lambda functions I’ve worked with have been either python or NodeJS, but we recently had a project that needed to update a database from inside of a deployment pipeline.
We’re trying to retire an old admin box where users would run Powershell management scripts to do things like provision servers, configure customer accounts, etc."><meta name=twitter:site content="@_sfdevs"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-89597259-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>window.fbAsyncInit=function(){FB.init({appId:'1171673062996168',cookie:true,xfbml:true,version:'v3.2'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/en_US/sdk.js";fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><body class=subpage><header id=header><div class=inner><a href=https://sfdevs.com/ class=logo>SFDevs</a><nav id=nav role=menu><a href=/about/><span>About</span></a>
<a href=/posts/><span>Community Posts</span></a>
<a href=/jobs/><span>Jobs</span></a></nav><a href=#navPanel class=navPanelToggle><span class="fa fa-bars"></span></a></div></header><section class=wrapper><div class=inner><header class=align-center><h1>AWS Lambda Functions with Modular Powershell</h1></header><p>It’s been a while since AWS released support for running <a href=https://docs.aws.amazon.com/lambda/latest/dg/powershell-programming-model.html>Powershell in Lambda Functions</a>. Up until now all of the Lambda functions I’ve worked with have been either python or NodeJS, but we recently had a project that needed to update a database from inside of a deployment pipeline.</p><p>We’re trying to retire an old admin box where users would run Powershell management scripts to do things like provision servers, configure customer accounts, etc. Rather than trust a user to remember which script to run, pick the right parameters, check the output, etc, etc, we wanted all of that to happen as part of a CICD pipeline.</p><p>I know what you’re thinking: “Why would you drag along the powershell scripts? It’s probably a zillion line single script that’s impossible to debug or manage.” But the codebase is pretty well designed — it’s modular, implements defensive programming, has tons of business logic in it, and most of it has >50% unit test coverage with <a href=https://github.com/pester/Pester>Pester</a>. So there’s a lot of good stuff there that would take time to rebuild in another language.</p><h3 id=so-whats-ournbspplan>So what’s our plan?</h3><p>Our goals are to have a Lambda function that runs some .NET Core powershell code. The code needs have unit tests that can be run in a CI environment, and be deployed from a pipeline.</p><p>The .NET core requirement is interesting. As a windows user I’m still on Powershell 5.1 on my laptop and I use AWSPowershellTools (the old monolithic Powershell module). That’s not to say I couldn’t make the jump, but I’d rather not risk breaking my other tooling for this one project. So we’ll setup a docker environment to do our local development. Let’s get started!</p><p>It’s probably obvious, but I’ll be assuming you’re working on a windows machine.</p><h3 id=setting-up-a-docker-image-for-thenbspbuild>Setting up a Docker image for the build</h3><p>The first thing we need is a docker image we can use to run our local builds and deploys in.</p><p>My first instinct was to use an image from the <a href=https://hub.docker.com/_/microsoft-powershell>Powershell repo</a>, but I had a terrible time getting the right version of .NET Core installed. I was getting errors running the Powershell commandlets for building the lambda functions, .NET core install errors, and the list went on.</p><p>After struggling for a while I flipped to the <a href=https://hub.docker.com/_/microsoft-dotnet-core-sdk>mcr.microsoft.com/dotnet/core/sdk</a> run time, and it worked much better. After reading several of the tutorials I decided to use the 2.1-bionic tag because</p><ul><li>Lambda functions are going to run in a linux environment- It’s smaller than running a windows container- it worked! 
The first step is to get into the container and see what tools we’ll need. So I ran</li></ul><p>And of course because this is a linux container our interpreter is bash off the bad. Installing powershell is pretty easy</p><p>That gives us the <code>pwsh</code> program we can use to get into Powershell on the linux container. To see this running try</p><p>Next we need the python to get pip, and pip to install the AWS CLI. For some reason the AWSLambdaPSCore uses the AWS CLI for it’s deployment work instead of the AWS Powershell Tools. That’s an interesting choice, but it works</p><p>This will take several minutes while your container downloads You can run these as separate commands too if you’d like. When you see the AWS CLI print it’s version you know you’re setup!</p><p>Let’s we need to install the <a href=https://www.powershellgallery.com/packages/AWSLambdaPSCore/1.2.0.0>AWSLambdaPSCore</a> into the Powershell environment. To do that you’ll run</p><p>You can break that apart too if you want to. As long as you don’t see an error importing the Powershell Module you should be good to go! Let’s put all of that work into a docker file</p><p>You can build this by running this command inside of the directory with your Dockerfile</p><h3 id=project-structure>Project Structure</h3><p>Now that we have a working Dockerfile we need to create our project structure it will look like</p><ul><li><code>Update-MetaData</code> will hold our powershell handler function- <code>CommonModules</code> will hold our testable powershell code and unit tests- <code>scripts</code> will hold deployment tools- <code>docker-compose.yml</code> we’ll dig into later</li></ul><h3 id=creating-the-module-and-unitnbsptest>Creating the Module and Unit test</h3><p>Let’s create our common module first. You’ll need to create a new Powershell module manifest with <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-modulemanifest?view=powershell-7">New-ModuleManifest</a>.</p><p>This tells powershell to create a new module definition, points to the <code>Common.psm1</code> powershell module, and exports all functions. You can get a lot fancier with your psd1 files, but those are the basics to get started.</p><p>Next we’ll create a simple function in our common module</p><p>And add a single unit test for it in a <code>tests\Common.tests.ps1</code> file</p><p>The boiler plate code the top lets you execute your tests from either the <code>CommonModules</code> directory or the <code>CommonModules\tests</code> directory. We should be able to invoke this and see our tests pass</p><h3 id=powershell-handler>Powershell Handler</h3><p>Our Powershell handler is going to be hard to be a little hard to unit test. It seems like it has to be a ps1 file, and AWS Lambda is going to run the script from top to bottom. That makes it a little hard to inject unit tests if we have a lot of logic in that handler script.</p><p>That’s why we’re keeping our handler thin (and using the common modules we created above. Let’s look at a slim implementation of the Lambda Handler</p><p>The end of this script looks like pretty standard powershell, we import a module and call a function.</p><p>The top of the script is comments which get generated when you call <code>New-AWSPowerShelLambda</code> .</p><p>The middle of this script is interesting, though.</p><p>This line tells the AWS tools how to pull together the modules that your function requires. And here’s where we hit an interesting part of our build: we need a place for the lambda tools to find both your modules, and the AWSPowerShell.NetCore module.</p><h3 id=walking-through-thenbspbuild>Walking through the build</h3><p>This script will run inside of the container. We’ll start by creating a new temp directory, and registering it as a local powershell repo.</p><p>Now we’ll publish our common modules to it, and save the <code>AWSPowerShell.NetCore</code> module to it as well.</p><p>That gives our call to <code>Publish-AWSPowerShellLambda </code>a local repo to pull from.</p><p>That’s the build, lastly let’s pull it all together with a <code>docker-compose</code> file.</p><h3 id=docker-composenbspfile>Docker Compose File</h3><p><a href=https://docs.docker.com/compose/>Docker compose</a> is a tool for building and running multiple services at a time in a docker development environment. Among other things it lets you call out volumes to map into your container, which is our main use.</p><p>Our goal is to map the powershell script, modules, and our AWS credentials into the container so we can run the build using the .NET Core container.</p><p>Your <code>docker-compose</code> file will look like this</p><p>NOTE: There are some tricks to sharing files between a windows host and a linux container. There are some tips in my post <a href=https://rollingwebsphere.home.blog/2019/08/10/loving-docker-as-a-windows-guy-august-2019-2/>here</a>.</p><p>Lastly you’ll need to create a <code>.env</code> file (reference <a href=https://docs.docker.com/compose/env-file/>here</a>) that looks like this</p><p>And that’s it! You can build and deploy your lambda function with</p></div></section><footer id=footer><div class=inner><h3>Get in touch</h3><iframe src="https://services.cognitoforms.com/f/kLQF89okA06rKO0JYMWNOg?id=1" style=position:relative;width:1px;min-width:100%;*width:100% frameborder=0 scrolling=yes seamless height=465 width=100%></iframe>
<script src=https://services.cognitoforms.com/scripts/embed.js></script><div class="row footer__copy-social"><div class="copyright 6u 12u$(small)">&copy; 2020 Sioux Falls Developer's Group.</div><div class="6u 12u$(small) social"><div class=footer__social><span class=follow__social__copy>Follow SFDevs</span>
<a href=https://www.facebook.com/sfdevs title="Follow us on Facebook" class=like-us target=_blank rel=noopener><i class="fab fa-facebook fa-2x"></i></a><a href=https://twitter.com/_sfdevs title="Follow us on Twitter" class=like-us target=_blank rel=noopener><i class="fab fa-twitter fa-2x"></i></a></div></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin=anonymous></script><script src=/js/skel.min.js></script><script src=/js/main.min.js></script></body></html>