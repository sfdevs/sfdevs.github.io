<!DOCTYPE html>
<html lang="en"><meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>SFDevs  | Building a usable ext-tidy for Alpine-based PHP Docker images</title>
<meta name="description" content="I&rsquo;ve been working on building PHP Docker images for the purposes of testing, as well as to potentially provide images containing the Swoole extension. This is generally straight-forward, as the official PHP images are well-documented.
This week, I decided to see if I could build Alpine-based images, as they can greatly reduce the final image size. And I ran into a problem.
One of the test-beds I use builds RSS and Atom feeds using zend-feed.">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/solid.js" integrity="sha384-IA6YnujJIO+z1m4NKyAGvZ9Wmxrd4Px8WFqhFcgRmwLaJaiwijYgApVpo1MV8p77" crossorigin="anonymous"></script>
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/brands.js" integrity="sha384-rUOIFHM3HXni/WG5pzDhA1e2Js5nn4bWudTYujHbbI9ztBIxK54CL4ZNZWwcBQeD" crossorigin="anonymous"></script>
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/fontawesome.js" integrity="sha384-EMmnH+Njn8umuoSMZ3Ae3bC9hDknHKOWL2e9WJD/cN6XLeAN7tr5ZQ0Hx5HDHtkS" crossorigin="anonymous"></script>




<link rel="stylesheet" href="/styles/main.b8186dec878e18853a059792b7bd6cc35a21a0505c9c9dfdd756851c89f3ef30.css" integrity="sha256-uBht7IeOGIU6BZeSt71sw1ohoFBcnJ3911aFHInz7zA=">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#6cc091">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#6cc091"><meta property="og:title" content="Building a usable ext-tidy for Alpine-based PHP Docker images" />
<meta property="og:description" content="I&rsquo;ve been working on building PHP Docker images for the purposes of testing, as well as to potentially provide images containing the Swoole extension. This is generally straight-forward, as the official PHP images are well-documented.
This week, I decided to see if I could build Alpine-based images, as they can greatly reduce the final image size. And I ran into a problem.
One of the test-beds I use builds RSS and Atom feeds using zend-feed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sfdevs.com/posts/2018-11-01-phly-boy-phly-matthew-weier-o-phinney-building-a-usable-ext-tidy-for-alpine-based-php-docker-images/" />
<meta property="article:published_time" content="2018-11-01T22:23:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-11-01T22:23:00&#43;00:00"/>

  <meta property="fb:app_id" content="1171673062996168" />

<meta itemprop="name" content="Building a usable ext-tidy for Alpine-based PHP Docker images">
<meta itemprop="description" content="I&rsquo;ve been working on building PHP Docker images for the purposes of testing, as well as to potentially provide images containing the Swoole extension. This is generally straight-forward, as the official PHP images are well-documented.
This week, I decided to see if I could build Alpine-based images, as they can greatly reduce the final image size. And I ran into a problem.
One of the test-beds I use builds RSS and Atom feeds using zend-feed.">


<meta itemprop="datePublished" content="2018-11-01T22:23:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-11-01T22:23:00&#43;00:00" />
<meta itemprop="wordCount" content="462">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building a usable ext-tidy for Alpine-based PHP Docker images"/>
<meta name="twitter:description" content="I&rsquo;ve been working on building PHP Docker images for the purposes of testing, as well as to potentially provide images containing the Swoole extension. This is generally straight-forward, as the official PHP images are well-documented.
This week, I decided to see if I could build Alpine-based images, as they can greatly reduce the final image size. And I ran into a problem.
One of the test-beds I use builds RSS and Atom feeds using zend-feed."/>
<meta name="twitter:site" content="@_sfdevs"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-89597259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '1171673062996168',
        cookie     : true,
        xfbml      : true,
        version    : 'v3.2'
      });
      FB.AppEvents.logPageView();
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

<body class="subpage"><header id="header">
    <div class="inner">
        <a href="https://sfdevs.com/" class="logo">SFDevs</a>
        <nav id="nav" role="menu">
        
        
            <a class="" href="/about/">
                <span>About</span>
            </a>
        
            <a class="" href="/posts/">
                <span>Community Posts</span>
            </a>
        
            <a class="" href="/jobs/">
                <span>Jobs</span>
            </a>
        
        </nav>
        <a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
    </div>
</header>

<section class="wrapper">
    <div class="inner">
    <header class="align-center">
        <h1>Building a usable ext-tidy for Alpine-based PHP Docker images</h1>
    </header>

    <p>I&rsquo;ve been working on building PHP Docker images for the purposes of testing, as
well as to potentially provide images containing the Swoole extension. This is
generally straight-forward, as the official PHP images are well-documented.</p>

<p>This week, I decided to see if I could build Alpine-based images, as they can
greatly reduce the final image size. And I ran into a problem.</p>

<p>One of the test-beds I use builds RSS and Atom feeds using <a href="https://docs.zendframework.com/zend-feed">zend-feed</a>.
When I tried one of these images, I started getting failures like the following:</p>

<pre><code>PHP Warning:  DOMDocument::loadXML(): xmlParseEntityRef: no name in Entity, line: 167 in /var/www/vendor/zendframework/zend-feed/src/Writer/Renderer/Entry/Atom.php on line 404
PHP Fatal error:  Uncaught TypeError: Argument 1 passed to DOMDocument::importNode() must be an instance of DOMNode, null given in /var/www/vendor/zendframework/zend-feed/src/Writer/Renderer/Entry/Atom.php:371
Stack trace:
#0 /var/www/vendor/zendframework/zend-feed/src/Writer/Renderer/Entry/Atom.php(371): DOMDocument-&amp;gt;importNode(NULL, 1)
#1 /var/www/vendor/zendframework/zend-feed/src/Writer/Renderer/Entry/Atom.php(53): Zend\Feed\Writer\Renderer\Entry\Atom-&amp;gt;_setContent(Object(DOMDocument), Object(DOMElement))
#2 /var/www/vendor/zendframework/zend-feed/src/Writer/Renderer/Feed/Atom.php(91): Zend\Feed\Writer\Renderer\Entry\Atom-&amp;gt;render()
#3 /var/www/vendor/zendframework/zend-feed/src/Writer/Feed.php(237): Zend\Feed\Writer\Renderer\Feed\Atom-&amp;gt;render()
#4 /var/www/src/Blog/Console/FeedGenerator.php(209): Zend\Feed\Writer\Feed-&amp;gt;export('Atom')

</code></pre>

<p>During an initial search, this appeared to be a problem due to libxml2 versions,
and so I went down a rabbit hole trying to get an older libxml2 version in
place, and have all of the various XML extensions compile against it. However,
the error persisted.</p>

<p>So, I did a little more sleuthing. I fired up the container with a shell:</p>

<pre><code>$ docker run --entrypoint /bin/sh -it php:7.2-cli-alpine3.8

</code></pre>

<p>From there, I used <code>apk</code> to add some editing and debugging tools so I could
manually step through some of the code. In doing so, I was able to discover the
exact feed item that was causing problems, and, better, get the content it was
trying to use.</p>

<p>I realized at that point that the problem was the content â€” which was
being massaged via the <a href="http://php.net/tidy">tidy extension</a> before being passed
to <code>DOMDocument::loadXML()</code>. For some reason, the content generated was not
valid XML! (Which is really, really odd, as the whole point of tidy is to
produce valid markup!)</p>

<p>I checked the version of ext-tidy, and what version of libtidy it was compiled
against, and then checked against the php:7.2-cli image to see what it had, and
discovered that while Alpine was using libtidy 5.6.0, the Debian-based image was
using 5.2.0. In fact, Ubuntu 18:10 still distributes 5.2.0!</p>

<p>So, I then went on a quest to figure out how to get the earlier libtidy version,
and compile the tidy extension against it. This is what I came up with:</p>

<pre><code># DOCKER-VERSION        1.3.2

FROM php:7.2-cli-alpine3.8

# Compile-time dependencies
RUN echo 'http://dl-cdn.alpinelinux.org/alpine/v3.6/community' &amp;gt;&amp;gt; /etc/apk/repositories
RUN apk update &amp;amp;&amp;amp; \
  apk add --no-cache 'tidyhtml-dev==5.2.0-r1'

# Install the extension
RUN docker-php-ext-install -j$(nproc) tidy

</code></pre>

<p>Once I&rsquo;d built an image using the above, I tried out my code, and the errors
disappeared!</p>

<blockquote>
<p>This post mainly exists because my google searches were finding nothing.
Hopefully, somebody else who runs into the problem will get something useful
going forward!</p>
</blockquote>

    </div>
</section>
<footer id="footer">
    <div class="inner">
        <h3>Get in touch</h3>

        <iframe src="https://services.cognitoforms.com/f/kLQF89okA06rKO0JYMWNOg?id=1" style="position:relative;width:1px;min-width:100%;*width:100%;" frameborder="0" scrolling="yes" seamless="seamless" height="465" width="100%"></iframe>
        <script src="https://services.cognitoforms.com/scripts/embed.js"></script>

        <div class="copyright">
            &copy; 2019 Sioux Falls Developer's Group.
        </div>
    </div>
</footer>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
        crossorigin="anonymous"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/main.min.js"></script>
</body>
</html>
