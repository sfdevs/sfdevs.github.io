<!DOCTYPE html>
<html lang="en"><meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>SFDevs  | Registering Module-Specific Routes in Expressive</title>
<meta name="description" content="In Expressive, we have standardized on a file named
config/routes.php to contain all your route registrations. A typical file
might look something like this:">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/solid.js" integrity="sha384-IA6YnujJIO+z1m4NKyAGvZ9Wmxrd4Px8WFqhFcgRmwLaJaiwijYgApVpo1MV8p77" crossorigin="anonymous"></script>
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/brands.js" integrity="sha384-rUOIFHM3HXni/WG5pzDhA1e2Js5nn4bWudTYujHbbI9ztBIxK54CL4ZNZWwcBQeD" crossorigin="anonymous"></script>
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/fontawesome.js" integrity="sha384-EMmnH+Njn8umuoSMZ3Ae3bC9hDknHKOWL2e9WJD/cN6XLeAN7tr5ZQ0Hx5HDHtkS" crossorigin="anonymous"></script>




<link rel="stylesheet" href="/styles/main.b8186dec878e18853a059792b7bd6cc35a21a0505c9c9dfdd756851c89f3ef30.css" integrity="sha256-uBht7IeOGIU6BZeSt71sw1ohoFBcnJ3911aFHInz7zA=">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#6cc091">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#6cc091"><meta property="og:title" content="Registering Module-Specific Routes in Expressive" />
<meta property="og:description" content="In Expressive, we have standardized on a file named
config/routes.php to contain all your route registrations. A typical file
might look something like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sfdevs.com/posts/2019-01-24-phly-boy-phly-matthew-weier-o-phinney-registering-module-specific-routes-in-expressive/" />
<meta property="article:published_time" content="2019-01-24T17:30:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-01-24T17:30:00&#43;00:00"/>

  <meta property="fb:app_id" content="1171673062996168" />

<meta itemprop="name" content="Registering Module-Specific Routes in Expressive">
<meta itemprop="description" content="In Expressive, we have standardized on a file named
config/routes.php to contain all your route registrations. A typical file
might look something like this:">


<meta itemprop="datePublished" content="2019-01-24T17:30:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-01-24T17:30:00&#43;00:00" />
<meta itemprop="wordCount" content="643">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Registering Module-Specific Routes in Expressive"/>
<meta name="twitter:description" content="In Expressive, we have standardized on a file named
config/routes.php to contain all your route registrations. A typical file
might look something like this:"/>
<meta name="twitter:site" content="@_sfdevs"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-89597259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '1171673062996168',
        cookie     : true,
        xfbml      : true,
        version    : 'v3.2'
      });
      FB.AppEvents.logPageView();
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

<body class="subpage"><header id="header">
    <div class="inner">
        <a href="https://sfdevs.com/" class="logo">SFDevs</a>
        <nav id="nav" role="menu">
        
        
            <a class="" href="/about/">
                <span>About</span>
            </a>
        
            <a class="" href="/posts/">
                <span>Community Posts</span>
            </a>
        
            <a class="" href="/jobs/">
                <span>Jobs</span>
            </a>
        
        </nav>
        <a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
    </div>
</header>

<section class="wrapper">
    <div class="inner">
    <header class="align-center">
        <h1>Registering Module-Specific Routes in Expressive</h1>
    </header>

    <p>In <a href="https://getexpressive.org">Expressive</a>, we have standardized on a file named
<code>config/routes.php</code> to contain all your route registrations. A typical file
might look something like this:</p>

<pre><code>declare(strict_types=1);

use Zend\Expressive\Csrf\CsrfMiddleware;
use Zend\Expressive\Session\SessionMiddleware;

return function (
    \Zend\Expressive\Application $app,
    \Zend\Expressive\MiddlewareFactory $factory,
    \Psr\Container\ContainerInterface $container
) : void {
    $app-&amp;gt;get('/', App\HomePageHandler::class, 'home');

    $app-&amp;gt;get('/contact', [
        SessionMiddleware::class,
        CsrfMiddleware::class,
        App\Contact\ContactPageHandler::class
    ], 'contact');
    $app-&amp;gt;post('/contact', [
        SessionMiddleware::class,
        CsrfMiddleware::class,
        App\Contact\ProcessContactRequestHandler::class
    ]);
    $app-&amp;gt;get(
        '/contact/thank-you',
        App\Contact\ThankYouHandler::class,
        'contact.done'
    );

    $app-&amp;gt;get(
        '/blog[/]',
        App\Blog\Handler\LandingPageHandler::class,
        'blog'
    );
    $app-&amp;gt;get('/blog/{id:[^/]+\.html', [
        SessionMiddleware::class,
        CsrfMiddleware::class,
        App\Blog\Handler\BlogPostHandler::class,
    ], 'blog.post');
    $app-&amp;gt;post('/blog/comment/{id:[^/]+\.html', [
        SessionMiddleware::class,
        CsrfMiddleware::class,
        App\Blog\Handler\ProcessBlogCommentHandler::class,
    ], 'blog.comment');
}

</code></pre>

<p>and so on.</p>

<p>These files can get <strong>really</strong> long, and organizing them becomes imperative.</p>

<h2 id="using-delegator-factories">Using Delegator Factories</h2>

<p>One way we have recommended to make these files simpler is to use <a href="https://docs.zendframework.com/zend-expressive/v3/features/container/delegator-factories/">delegator
factories</a>
registered with the <code>Zend\Expressive\Application</code> class to add routes. That
looks something like this:</p>

<pre><code>namespace App\Blog;

use Psr\Container\ContainerInterface;
use Zend\Expressive\Application;
use Zend\Expressive\Csrf\CsrfMiddleware;
use Zend\Expressive\Session\SessionMiddleware;

class RoutesDelegator
{
    public function __invoke(
        ContainerInterface $container,
        string $serviceName,
        callable $callback
    ) : Application {
        /** @var Application $app */
        $app = $callback();

        $app-&amp;gt;get(
            '/blog[/]',
            App\Blog\Handler\LandingPageHandler::class,
            'blog'
        );
        $app-&amp;gt;get('/blog/{id:[^/]+\.html', [
            SessionMiddleware::class,
            CsrfMiddleware::class,
            Handler\BlogPostHandler::class,
        ], 'blog.post');
        $app-&amp;gt;post('/blog/comment/{id:[^/]+\.html', [
            SessionMiddleware::class,
            CsrfMiddleware::class,
            Handler\ProcessBlogCommentHandler::class,
        ], 'blog.comment');

        return $app;
    }
}

</code></pre>

<p>You would then register this as a delegator factory somewhere in your
configuration:</p>

<pre><code>use App\Blog\RoutesDelegator;
use Zend\Expressive\Application;

return [
    'dependencies' =&amp;gt; [
        'delegators' =&amp;gt; [
            Application::class =&amp;gt; [
                RoutesDelegator::class,
            ],
        ],
    ],
];

</code></pre>

<p>Delegator factories run after the service has been created for the first time,
but before it has been returned by the container. They allow you to interact
with the service before it&rsquo;s returned; you can configure it futher, add
listeners, use it to configure other services, or even use them to replace the
instance with an alternative. In this example, we&rsquo;re opting to <strong>configure</strong> the
<code>Application</code> class further by registering routes with it.</p>

<p><a href="https://docs.zendframework.com/zend-expressive/v3/cookbook/autowiring-routes-and-pipelines/">We&rsquo;ve even written this approach up in our documentation.</a></p>

<p>So far, so good. But it means discovering where routes are registered becomes
more difficult. You now have to look in each of:</p>

<p><li>
<code>config/routes.php</code>
</li>
<li>Each file in <code>config/autoload/</code>:
<ul>
- looking for delegators attached to the <code>Application</code> class,
- and then checking those to see if they register routes.</p>

<ul>
<li>looking for delegators attached to the <code>Application</code> class,</li>
<li>and then checking those to see if they register routes.</li>
</ul>

<p>The larger your application gets, the more work this becomes. Your
<code>config/routes.php</code> becomes way more readable, but it becomes far harder to find
all your routes.</p>

<h2 id="one-off-functions">One-off Functions</h2>

<p>In examining this problem for the upteenth time this week, I stumbled upon a
solution that is initially acceptable to me, finally.</p>

<p>What I&rsquo;ve done is as follows:</p>

<p><li>I&rsquo;ve created a function in my <code>ConfigProvider</code> that accepts the <code>Application</code>
instance and any other arguments I want to pass to it, and which registers
routes with the instance.</li>
- I call that function within my <code>config/routes.php</code>.</p>

<p>Building on the example above, the <code>ConfigProvider</code> for the <code>App\Blog</code> module
now has the following method:</p>

<pre><code>namespace App\Blog;

use Zend\Expressive\Application;
use Zend\Expressive\Csrf\CsrfMiddleware;
use Zend\Expressive\Session\SessionMiddleware;

class ConfigProvider
{
    public function __invoke() : array
    {
        /* ... */
    }

    public function registerRoutes(
        Application $app,
        string $basePath = '/blog'
    ) : void {
        $app-&amp;gt;get(
            $basePath . '[/]',
            App\Blog\Handler\LandingPageHandler::class,
            'blog'
        );
        $app-&amp;gt;get($basePath . '/{id:[^/]+\.html', [
            SessionMiddleware::class,
            CsrfMiddleware::class,
            Handler\BlogPostHandler::class,
        ], 'blog.post');
        $app-&amp;gt;post($basePath . '/comment/{id:[^/]+\.html', [
            SessionMiddleware::class,
            CsrfMiddleware::class,
            Handler\ProcessBlogCommentHandler::class,
        ], 'blog.comment');
    }
}

</code></pre>

<p>Within my <code>config/routes.php</code>, I can create a temporary instance and call the
method:</p>

<pre><code>declare(strict_types=1);

return function (
    \Zend\Expressive\Application $app,
    \Zend\Expressive\MiddlewareFactory $factory,
    \Psr\Container\ContainerInterface $container
) : void {
    (new \App\Blog\ConfigProvider())-&amp;gt;registerRoutes($app);
}

</code></pre>

<p>This approach eliminates the problems of using delegator factories:</p>

<ul>
<li>There&rsquo;s a clear indication that a given class method registers routes.</li>
<li>I can then look directly at that method to determine what they are.</li>
</ul>

<p>One thing I like about this approach is that it allows me to keep the routes
close to the code that handles them (i.e., within each module), while still
giving me control over their registration at the application level.</p>

<p>What strategies have you tried?</p>
    </div>
</section>
<footer id="footer">
    <div class="inner">
        <h3>Get in touch</h3>

        <iframe src="https://services.cognitoforms.com/f/kLQF89okA06rKO0JYMWNOg?id=1" style="position:relative;width:1px;min-width:100%;*width:100%;" frameborder="0" scrolling="yes" seamless="seamless" height="465" width="100%"></iframe>
        <script src="https://services.cognitoforms.com/scripts/embed.js"></script>

        <div class="copyright">
            &copy; 2019 Sioux Falls Developer's Group.
        </div>
    </div>
</footer>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
        crossorigin="anonymous"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/main.min.js"></script>
</body>
</html>
